<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome to Nothing</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .content {
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      footer {
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <h1>Welcome to Nothing</h1>
      <p>⚠️ Don't use your real passwords. This is just for fun.</p>

      <form id="claimForm">
        <label for="password">Your Password</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          minlength="3"
          autocomplete="off"
        />
        <br /><br />
        <button type="submit" id="claimButton">Claim It</button>
      </form>

      <div id="result"></div>
    </div>

    <footer>
      <hr />
      <p><small>© 2025 Nothing Corp. No passwords reserved.</small></p>
    </footer>

    <script>
      // Fetch environment variables from server
      let supabase;

      async function initializeApp() {
        try {
          const response = await fetch('/api/config');
          const config = await response.json();

          if (!config.supabaseUrl || !config.supabaseAnonKey) {
            throw new Error('Missing configuration');
          }

          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseAnonKey
          );
        } catch (err) {
          console.error('Failed to load configuration:', err);
          showResult(
            'Failed to load app configuration. Please check server setup.',
            'error'
          );
        }
      }

      // Initialize on page load
      initializeApp();

      // Get form elements
      const form = document.getElementById('claimForm');
      const passwordInput = document.getElementById('password');
      const claimButton = document.getElementById('claimButton');
      const resultDiv = document.getElementById('result');

      // Handle form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = passwordInput.value.trim();

        // Validate minimum length
        if (password.length < 3) {
          showResult('Password must be at least 3 characters long.', 'error');
          return;
        }

        // Disable button during processing
        claimButton.disabled = true;
        claimButton.textContent = 'Claiming...';
        hideResult();

        try {
          // Try to insert the password
          const { data, error } = await supabase
            .from('claimed_passwords')
            .insert([{ password: password }])
            .select();

          if (error) {
            // Check if it's a unique constraint violation
            if (
              error.code === '23505' ||
              error.message.includes('duplicate') ||
              error.message.includes('unique')
            ) {
              showResult(
                'Password already taken! please choose another.',
                'error'
              );
            } else {
              showResult('An error occurred. Please try again.', 'error');
              console.error('Supabase error:', error);
            }
          } else {
            showResult(
              'Congrats! Your password is now claimed. You own nothing.',
              'success'
            );
            passwordInput.value = '';
          }
        } catch (err) {
          showResult(
            'An unexpected error occurred. Please try again.',
            'error'
          );
          console.error('Error:', err);
        } finally {
          // Re-enable button
          claimButton.disabled = false;
          claimButton.textContent = 'Claim It';
        }
      });

      function showResult(message, type) {
        resultDiv.textContent = message;
      }

      function hideResult() {
        resultDiv.textContent = '';
      }
    </script>
  </body>
</html>
